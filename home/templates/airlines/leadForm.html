<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css">

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<style>
  /* ========== CUSTOM STYLES TO MATCH SCREENSHOT ========== */
  /* Overall Section Background */
  .leadform-promo-section {
    padding: 12px 0;
  }

  /* Title: "Cheap Flights to Asia" */
  .leadform-promo-section .leadform-section-title {
    font-size: 2rem;
    font-weight: 700;
    color: #2c2c2c;
    margin-bottom: 2rem;
    text-align: center;
  }

  /* Left Card: "SUPER SAVER FARE" Box */
  .leadform-promo-offer-box {
    margin-top: 120px;
    position: relative;
    background: #fff;
    border: 2px dashed #ccc;
    outline: 10px solid white;
    color: #000;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  .leadform-promo-offer-box-content {
    padding: 10px;
    border: 2px dashed #ccc;
    margin-top: -85px;
    background-color: white;
  }

  .leadform-promo-offer-box h3 {
    color: #d10a0a;
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 24px;
  }

  .leadform-promo-price {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2c2c2c;
  }
  .leadform-promo-price-strike {
    font-size: 1.25rem;
    color: #d10a0a;
    text-decoration: line-through;
    margin-left: 0.5rem;
  }

  /* Right Card: Search Form */
  .leadform-search-form-card {
    background: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    padding: 2rem;
  }

  .leadform-search-form-card .leadform-top-info {
    text-align: center;
    margin-bottom: 1rem;
  }
  .leadform-search-form-card .leadform-top-info h3 {
    font-weight: 700;
    color: #2c2c2c;
    margin-bottom: 0.5rem;
  }
  .leadform-voucher-code {
    color: #2c2c2c;
    font-size: 0.9rem;
  }

  .leadform-phone-btn {
    background-color: #119148;
    color: #fff;
    border: none;
    font-weight: 600;
    padding: .9rem .7rem;
    border-radius: 8px;
    cursor: pointer;
  }

  .leadform-trip-tabs .btn {
    border-radius: 0;
    font-weight: 600;
  }
  .leadform-trip-tabs .leadform-btn-primary-custom {
    background-color: #d10a0a;
    border-color: #d10a0a;
    color: white;
    font-weight: 600;
    border-radius: 3px;
  }
  .leadform-trip-tabs .leadform-btn-secondary {
    background-color: #f2f2f2;
    color: #555;
    border: none;
  }

  .leadform-form-label {
    font-weight: 600;
    color: #2c2c2c;
    font-size: 0.9rem;
  }
  /* Note: remove any stray punctuation in your class names if not needed */

  .leadform-btn-danger {
    background-color: #d10a0a !important;
    border-color: #d10a0a !important;
    font-weight: 700;
  }

  .leadform-how-it-works {
    font-size: 0.9rem;
    color: #0066cc;
    text-decoration: underline;
    cursor: pointer;
  }

  .leadform-disclaimer-text {
    font-size: 0.75rem;
    color: #666;
    line-height: 1.2;
    margin-top: 0.75rem;
  }

  @media (max-width: 768px) {
    #offerBox {
      display: none;
    }
    #searchCard {
      /* margin-top: 20px; */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      /* background-color: rgba(0, 0, 0, 0.5); */
      /* backdrop-filter: blur(10px); */
      /* padding: 20px; */
      /* border-radius: 10px; */
      /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); */
      width: 100%;
      height: 100%;
      overflow-x: auto;
    }
    .leadform-mob-none {
      display: none !important;
    }
    .leadform-mob-p-0 {
      padding: 4px !important;
    }
  }
</style>

<!-- ========== BODY CONTENT ========== -->
<section id="promo-section" class="leadform-promo-section">
  <div style="max-width: 1300px;" class="container">
    <div class="row justify-content-center g-4">
      <!-- LEFT COLUMN: Offer Box -->
      <div id="offerBox" class="col-md-5">
        <div class="leadform-promo-offer-box">
          <div class="leadform-promo-offer-box-content">
            <h3>SUPER SAVER FARE</h3>
            <p class="mb-1">Limited-time Offer! ENDS Mar 19</p>
          </div>
          <p class="mb-3" style="font-weight: 600; margin-top: 10px;">
            Save up to 50% OFF!<br>Lowest fares from the travel experts
          </p>
          <div class="mb-3">
            <p class="text-dark fw-semibold mb-0">ALL IN [Round Trip]</p>
          </div>
          <p class="mb-1">Excellent 4.9 out of 5 <i class="fas fa-star text-success"></i></p>
          <small class="text-muted d-block mb-3">Trustpilot</small>
          <p class="mb-2">1 in 11 people who visit Asia book the TravelPae Tickets</p>
          <p class="fw-bold">Call Toll-Free for Best Fare!</p>
        </div>
      </div>

     <!-- RIGHT COLUMN: Search Form -->
<div class="col-12 col-md-7">
    <div id="searchCard" class="leadform-search-form-card">
      <!-- Success Message (initially hidden) -->
      <div id="formSuccessMessage" class="d-none text-center p-4 mt-5 mb-5" role="alert" aria-live="polite">
        <div class="p-4 rounded shadow-sm" style="background-color: white; border: 1px solid #c3e6cb;">
          <h4 class="mb-3" style="color: #155724;">
            <i style="font-size: 54px; margin-bottom: 10px; color: #155724;" class="fas fa-check-circle me-2"></i>
            <br>Request Received!
          </h4>
          <p class="mb-4" style="color: #155724;">
            Thank you for reaching out. A travel expert will call you shortly at<br>
            <strong style="color: #0c5460;">+1 (888) 843-5849</strong>.
          </p>
          <button id="closeSuccessMessage" class="btn btn-outline-success">
            <i class="fas fa-times me-1"></i> Dismiss
          </button>
        </div>
      </div>
  
      <!-- Form Content (will be hidden on success) -->
      <div id="formContent">
        <!-- Top Info -->
        <!--give a close button-->
        <button class="d-md-none" style="position: absolute; top: 10px; right: 10px;outline: none;border: none;background: none;cursor: pointer;" onclick="document.getElementById('promo-section').style.display = 'none';">
          <i class="fas fa-times"></i>
        </button>


        <div class="leadform-top-info" style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
          <h3 class="leadform-mob-none" style="font-size: 16px; margin: 5px 10px; white-space: nowrap;">SAVE $30 EXTRA <br>Call Toll-FREE</h3>
          <h3 class="bold d-md-none" style="font-size: 16px; margin: 5px 10px; white-space: nowrap;"><strong>Call Toll-Free</strong>: Get the Best Deals</h3>
          <button class="leadform-mob-none leadform-phone-btn" style="white-space: nowrap; font-size: 16px; margin: 5px 10px;" onclick="window.location.href='tel:+18888435849'">
            <i class="fas fa-phone me-1"></i> +1 (888) 843-5849
          </button>
          <button class="d-md-none leadform-phone-btn" style="width: 100%;white-space: nowrap; font-size: 16px; margin: 5px 10px;font-weight: 500;" onclick="window.location.href='tel:+18888435849'">
            <i class="fas fa-phone me-1"></i> Call & Save $30 - <br>Voucher Code: <strong>TRAVELPAE30</strong>
          </button>
          <p class="leadform-mob-none leadform-voucher-code" style="font-size: 16px; margin: 5px 10px;">Voucher Code: <br><strong>TRAVELPAE30</strong></p>
        </div>
        <p class="leadform-mob-none text-center text-muted mb-4" style="margin-top: 16px;">
          or fill the request form, and we will call you back soon
        </p>
        <p class="d-md-none text-center text-muted mb-4" style="margin-top: 0px;font-size: 14px;">
            or fill the request form, and we will <br>call you back soon
          </p>
  
        <!-- Trip Tabs -->
        <div class="leadform-mob-none leadform-trip-tabs d-flex flex-column flex-sm-row justify-content-center gap-2 mb-2">
          <button type="button" class="btn leadform-btn-primary-custom w-100 w-sm-auto leadform-trip-tab" data-trip="round-trip">
            Round-Trip
          </button>
          <button type="button" class="btn leadform-btn-secondary w-100 w-sm-auto leadform-trip-tab" data-trip="one-way">
            One-Way
          </button>
          <button type="button" class="btn leadform-btn-secondary w-100 w-sm-auto leadform-trip-tab" data-trip="multi-city">
            Multi-City
          </button>
        </div>
  
        <!-- Forms -->
        <form id="flightSearchForm" method="POST" novalidate>
          <!-- Round Trip Form (Default) -->
          <div class="leadform-trip-form round-trip">
            <div class="row mb-3">
              <div class="col-6 leadform-mob-p-0">
                <label for="rt_departure" class="leadform-form-label">Departure Date</label>
                <input type="text" name="rt_departure" class="form-control" id="rt_departure" placeholder="Departure Date" required>
              </div>
              <div class="col-6 leadform-mob-p-0">
                <label for="rt_return" class="leadform-form-label">Return Date</label>
                <input type="text" name="rt_return" class="form-control" id="rt_return" placeholder="Return Date" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-sm-6 leadform-mob-p-0">
                <!-- <label for="rt_from" class="leadform-form-label">From</label> -->
                <select name="rt_from" id="rt_from" placeholder="From Airport" required></select>
              </div>
              <div class="col-sm-6 leadform-mob-p-0">
                <!-- <label for="rt_to" class="leadform-form-label">To</label> -->
                <select name="rt_to" id="rt_to" placeholder="To Airport" required></select>
              </div>
            </div>
            <div class="mb-3">
              <input type="email" name="rt_email" class="form-control" id="rt_email" placeholder="E-mail" required>
            </div>

            <div class="row mb-3">
              <div class="col-sm-6 leadform-mob-p-0">
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-flag-usa"></i> +1</span>
                  <input type="text" name="rt_phone" class="form-control" id="rt_phone" placeholder="Phone" required>
                </div>
              </div>
              <div class="col-sm-6 leadform-mob-p-0">
                <input type="text" name="rt_name" class="form-control" id="rt_name" placeholder="Your Name">
              </div>
            </div>
            <button type="submit" style="color: white;" class="btn leadform-btn-danger w-100 rounded-pill">
              GET A FREE QUOTE
            </button>
            
          </div>
  
          <!-- One Way Form -->
          <div class="leadform-trip-form one-way d-none">
            <div class="mb-3">
              <label for="ow_departure" class="leadform-form-label">Departure Date</label>
              <input type="text" name="ow_departure" class="form-control" id="ow_departure" placeholder="Departure Date" required>
            </div>
            <div class="row mb-3">
              <div class="col-sm-6">
                <!-- <label for="ow_from" class="leadform-form-label">From</label> -->
                <select name="ow_from" id="ow_from" placeholder="From Airport" required></select>
              </div>
              <div class="col-sm-6">
                <!-- <label for="ow_to" class="leadform-form-label">To</label> -->
                <select name="ow_to" id="ow_to" placeholder="To Airport" required></select>
              </div>
            </div>
            <div class="mb-3">
              <input type="email" name="ow_email" class="form-control" id="ow_email" placeholder="E-mail" required>
            </div>
            <div class="row mb-3">
              <div class="col-sm-6">
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-flag-usa"></i> +1</span>
                  <input type="text" name="ow_phone" class="form-control" id="ow_phone" placeholder="Phone" required>
                </div>
              </div>
              <div class="col-sm-6">
                <input type="text" name="ow_name" class="form-control" id="ow_name" placeholder="Your Name">
              </div>
            </div>
            <button type="submit" style="color: white;" class="btn leadform-btn-danger w-100 rounded-pill">
              GET A FREE QUOTE
            </button>
          </div>
  
          <!-- Multi-City Form -->
          <div class="leadform-trip-form multi-city d-none">
            <!-- Leg 1 -->
            <div class="card border-0">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-sm-6">
                    <!-- <label for="mc1_from" class="leadform-form-label">From</label> -->
                    <select name="mc1_from" id="mc1_from" placeholder="From Airport" required></select>
                  </div>
                  <div class="col-sm-6">
                    <!-- <label for="mc1_to" class="leadform-form-label">To</label> -->
                    <select name="mc1_to" id="mc1_to" placeholder="To Airport" required></select>
                  </div>
                </div>
                <div>
                  <label for="mc1_departure" class="leadform-form-label">Departure Date</label>
                  <input type="text" name="mc1_departure" class="form-control" id="mc1_departure" placeholder="Departure Date" required>
                </div>
              </div>
            </div>
            <!-- Leg 2 -->
            <div class="card border-0">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-sm-6">
                    <!-- <label for="mc2_from" class="leadform-form-label">From</label> -->
                    <select name="mc2_from" id="mc2_from" placeholder="From Airport" required></select>
                  </div>
                  <div class="col-sm-6">
                    <!-- <label for="mc2_to" class="leadform-form-label">To</label> -->
                    <select name="mc2_to" id="mc2_to" placeholder="To Airport" required></select>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="mc2_departure" class="leadform-form-label">Departure Date</label>
                  <input type="text" name="mc2_departure" class="form-control" id="mc2_departure" placeholder="Departure Date" required>
                </div>
              </div>
            </div>
            <!-- Contact Info -->
            <div class="mb-3">
              <input type="email" name="mc_email" class="form-control" id="mc_email" placeholder="E-mail" required>
            </div>
            <div class="row mb-3">
              <div class="col-sm-6">
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-flag-usa"></i> +1</span>
                  <input type="text" name="mc_phone" class="form-control" id="mc_phone" placeholder="Phone" required>
                </div>
              </div>
              <div class="col-sm-6">
                <input type="text" name="mc_name" class="form-control" id="mc_name" placeholder="Your Name">
              </div>
            </div>
            <button type="submit" style="color: white;" class="btn leadform-btn-danger w-100 rounded-pill">
              GET A FREE QUOTE
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>


    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ========== Helper Functions for Validation ==========
  function validateEmail(email) {
    var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }
  
  function validatePhone(phone) {
    // Basic phone validation: allow digits, spaces, +, -, and parentheses
    var re = /^[\d\s\+\-\(\)]+$/;
    return re.test(phone);
  }
  
  // Remove validation error on input change
  document.querySelectorAll('#flightSearchForm input').forEach(function(input) {
    input.addEventListener('input', function() {
      if (this.value.trim() !== "") {
        this.classList.remove('is-invalid');
      }
    });
  });
  
  // ========== Switch between trip forms ==========
  document.querySelectorAll(".leadform-trip-tab").forEach(function(button) {
    button.addEventListener("click", function() {
      // Update tab button styling
      document.querySelectorAll(".leadform-trip-tab").forEach(function(btn) {
        btn.classList.remove("leadform-btn-primary-custom");
        btn.classList.add("leadform-btn-secondary");
      });
      this.classList.remove("leadform-btn-secondary");
      this.classList.add("leadform-btn-primary-custom");
  
      // Hide all trip forms, show the selected one
      document.querySelectorAll(".leadform-trip-form").forEach(function(formSection) {
        formSection.classList.add("d-none");
      });
      const tripType = this.getAttribute("data-trip");
      const selectedForm = document.querySelector(".leadform-trip-form." + tripType);
      if (selectedForm) {
        selectedForm.classList.remove("d-none");
      }
    });
  });
  
  // ========== Initialize Datepickers using Flatpickr ==========
  flatpickr("#rt_departure", { defaultDate: new Date(), dateFormat: "m/d/Y" });
  flatpickr("#rt_return", { defaultDate: new Date(), dateFormat: "m/d/Y" });
  flatpickr("#ow_departure", { defaultDate: new Date(), dateFormat: "m/d/Y" });
  flatpickr("#mc1_departure", { defaultDate: new Date(), dateFormat: "m/d/Y" });
  flatpickr("#mc2_departure", { defaultDate: new Date(), dateFormat: "m/d/Y" });
  
  // ========== Client-side Form Validation and AJAX Submission ==========
  document.getElementById('flightSearchForm').addEventListener('submit', function(event) {
    event.preventDefault();
    let activeForm = document.querySelector('.leadform-trip-form:not(.d-none)');
    let valid = true;
  
    // Validate all required inputs in the visible trip form
    activeForm.querySelectorAll('input[required]').forEach(function(input) {
      if (!input.value.trim()) {
        input.classList.add('is-invalid');
        valid = false;
      } else {
        if (input.type === 'email' && !validateEmail(input.value.trim())) {
          input.classList.add('is-invalid');
          valid = false;
        }
        if (input.id.includes('phone') && !validatePhone(input.value.trim())) {
          input.classList.add('is-invalid');
          valid = false;
        }
      }
    });
  
    if (!valid) {
      alert("Please fill in all required fields correctly.");
      return;
    }
    
    // Disable submit button to prevent multiple submissions
    const submitButton = activeForm.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    
    // Prepare form data (include CSRF token if needed in Django)
    const formData = new FormData(this);
  
    // AJAX submission using Fetch API
    fetch("{% url 'flight_lead_form' %}", {
      method: "POST",
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
    .then(data => {
      // Show success message and hide form
      document.getElementById('formContent').classList.add('d-none');
      document.getElementById('formSuccessMessage').classList.remove('d-none');
      
      // Reset form for future submissions
      this.reset();
      submitButton.disabled = false;
    })
    .catch(error => {
      console.error("Error:", error);
      alert("There was an error submitting your request.");
      submitButton.disabled = false;
    });
  });
  
  // Handle close button on success message
  document.getElementById('closeSuccessMessage').addEventListener('click', function() {
    document.getElementById('formSuccessMessage').classList.add('d-none');
    document.getElementById('formContent').classList.remove('d-none');
  });

  // ========== Airport Selection with TomSelect ==========
  // TomSelect configuration for remote airport search
  const airportSelectConfig = {
    maxOptions: 50,
    valueField: 'value',
    labelField: 'label',
    searchField: ['code', 'name', 'city', 'country'],
    placeholder: 'Search Airport',
    render: {
      option: function(data, escape) {
        return `
          <div class="airport-option" style="padding: 8px 12px;">
            <div class="airport-code" style="display: flex; justify-content: space-between;">
              <span>${escape(data.name)}</span>
              <span style="font-size: 12px; font-weight: 500;">${escape(data.code)}</span>
            </div>
            <div class="airport-location" style="font-size: 12px; color: #888;">
              ${escape(data.city)}, ${escape(data.country)}
            </div>
          </div>
        `;
      },
      item: function(data, escape) {
        return `<div class="selected-airport"><strong>${escape(data.code)}</strong> - ${escape(data.name)}</div>`;
      }
    },
    onItemAdd() {
      this.blur();
    },
    load: function(query, callback) {
      if (!query.length) return callback();
      $.ajax({
        url: "{% url 'search_airports' %}",
        type: 'GET',
        data: { q: query },
        dataType: 'json',
        error: function() {
          callback();
        },
        success: function(res) {
          const options = res.map(airport => ({
            value: airport.iata ? airport.iata.toString() : '',
            code: airport.iata,
            name: airport.name,
            city: airport.city,
            country: airport.country,
            label: `${airport.iata} ${airport.name} (${airport.city}, ${airport.country})`
          }));
          callback(options);
        }
      });
    }
  };

  // Initialize TomSelect for all airport selectors
  const airportSelectors = [
    'rt_from', 'rt_to',
    'ow_from', 'ow_to',
    'mc1_from', 'mc1_to',
    'mc2_from', 'mc2_to'
  ];
  
  const tomSelectInstances = {};
  
  airportSelectors.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      tomSelectInstances[id] = new TomSelect(`#${id}`, {
        ...airportSelectConfig,
        placeholder: id.includes('from') ? 'From Airport' : 'To Airport'
      });
    }
  });

  // Helper function to prefill an airport select by airport code
  function prefillAirport(selectId, airportCode) {
    if (!airportCode || !tomSelectInstances[selectId]) return;
    
    $.ajax({
      url: "{% url 'search_airports' %}",
      type: 'GET',
      data: { q: airportCode },
      dataType: 'json',
      success: function(data) {
        const airport = data.find(item => item.iata === airportCode);
        if (airport) {
          const option = {
            value: airport.iata,
            code: airport.iata,
            name: airport.name,
            city: airport.city,
            country: airport.country,
            label: `${airport.iata} ${airport.name} (${airport.city}, ${airport.country})`
          };
          tomSelectInstances[selectId].addOption(option);
          tomSelectInstances[selectId].setValue(airportCode);
        }
      }
    });
  }

  // You can use the prefillAirport function to set default values
  // Example: prefillAirport('rt_from', 'JFK');
  // Example: prefillAirport('rt_to', 'LAX');
});
</script>


