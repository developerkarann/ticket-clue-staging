{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    html, body {
        background-color: #f5f5f6;
    }
    /* intl-tel-input styles */
    .iti {
        width: 100%;
    }
    .iti__flag {
        background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/img/flags.png");
    }
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .iti__flag {
            background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/img/flags@2x.png");
        }
    }
    /* OTP Verification Styles */
    .otp-container {
        max-width: 100%;
        margin: 20px auto;
        text-align: center;
    }
    .otp-inputs {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    .otp-input {
        width: 45px;
        height: 45px;
        font-size: 20px;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .otp-header {
        margin-bottom: 20px;
    }
    .edit-email-btn {
        background: none;
        border: none;
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
        font-size: 14px;
    }
    .spinner-border, .spinner-border2 {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
        /* display: none; */
    }
    
    /* Responsive styles */
    @media (max-width: 767px) {
        .container {
            padding-left: 8px;
            padding-right: 8px;
        }
        h1.h4 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }
        .form-label {
            font-size: 0.9rem;
        }
        .form-control {
            font-size: 0.95rem;
            padding: 0.5rem 0.75rem;
            height: auto;
        }
        .btn {
            padding: 0.6rem 1rem;
            font-size: 0.95rem;
        }
        .otp-input {
            width: 40px;
            height: 40px;
            font-size: 18px;
        }
        .p-sm-5 {
            padding: 1.5rem !important;
        }
        .p-4 {
            padding: 1rem !important;
        }
    }
    
    @media (max-width: 480px) {
        .container {
            padding-left: 5px;
            padding-right: 5px;
        }
        .otp-input {
            width: 35px;
            height: 35px;
            font-size: 16px;
        }
        .row.g-3 {
            margin-left: -5px;
            margin-right: -5px;
        }
        .col-6 {
            padding-left: 5px;
            padding-right: 5px;
        }
        .otp-header p {
            font-size: 0.85rem;
        }
        #otpEmail {
            display: block;
            word-break: break-all;
            margin-bottom: 5px;
        }
        .p-4 {
            padding: 0.75rem !important;
        }
    }
    
    /* Improve form spacing */
    .form-container {
        max-width: 100%;
    }
    .mb-3 {
        margin-bottom: 1rem !important;
    }
    
    /* Improve touch targets for mobile */
    @media (max-width: 767px) {
        .form-check-input, 
        .form-check-label {
            cursor: pointer;
        }
        .form-check-label {
            padding-left: 5px;
            font-size: 0.9rem;
        }
        .edit-email-btn {
            padding: 5px;
            font-size: 0.85rem;
        }
    }
</style>

<main>
    {% include 'components/error-trigger.html' %}
    <section class="d-flex align-items-center py-3 py-md-5">
        <div class="container">
            <div class="row justify-content-center">
                <!-- Registration Form Container -->
                <div id="registrationContainer" class="col-12 col-lg-10 col-xl-9 shadow rounded-3 overflow-hidden">
                    <div class="row g-0">
                        <!-- Left Image -->
                        <div class="col-lg-6 d-none d-lg-flex align-items-center p-4 bg-light">
                            <img src="{% static 'assets/images/element/signin.svg' %}" class="img-fluid" alt="Registration illustration">
                        </div>
                        <!-- Registration Form -->
                        <div class="col-lg-6 p-4 p-sm-5">
                            <a href="index.html">
                                <img src="{% static 'assets/images/logo.png' %}" alt="logo" class="h-30px mb-3 mb-md-4">
                            </a>
                            <h1 class="h4 mb-3 mb-md-4">Sign Up</h1>
                            <form id="signupForm" class="text-start form-container">
                                <div class="row g-3">
                                    <div class="mb-3 col-6">
                                        <label class="form-label" for="first_name">First Name</label>
                                        <input id="first_name" type="text" class="form-control" placeholder="John" required>
                                    </div>
                                    <div class="mb-3 col-6">
                                        <label class="form-label" for="last_name">Last Name</label>
                                        <input id="last_name" type="text" class="form-control" placeholder="Doe" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="email">Email</label>
                                    <input id="email" type="email" class="form-control" placeholder="example@mail.com" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="phone">Mobile Number</label>
                                    <input id="phone" type="tel" class="form-control" placeholder="123456789" required>
                                </div>
                                <div class="mb-3 position-relative">
                                    <label class="form-label" for="password">Password</label>
                                    <input id="password" class="form-control fakepassword" type="password" placeholder="•••••••" required>
                                    <span class="position-absolute end-0 top-50 translate-middle-y mt-3">
                                        <i style="margin-right: 10px;" class="fakepasswordicon fas fa-eye-slash cursor-pointer"></i>
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <div>
                                        <input id="rememberCheck" type="checkbox" class="form-check-input">
                                        <label for="rememberCheck" class="form-check-label">Remember me</label>
                                    </div>
                                </div>
                                <button type="submit" id="sendOtpBtn" class="btn btn-primary w-100 mb-3">
                                    <span class="spinner-border" role="status"></span>
                                    <span class="btn-text">Register</span>
                                </button>
                                <div class="position-relative my-4">
                                    <hr>
                                    <p class="small bg-white text-center position-absolute top-50 start-50 translate-middle px-3">Or</p>
                                </div>
                                <div class="d-grid gap-2">
                                    <a href="{% url 'login' %}" class="btn border btn-light">Log In</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- End of Registration Form Container -->

                <!-- OTP Verification Container (Hidden by Default) -->
                <div id="otpContainer" class="col-12 col-lg-10 col-xl-9 shadow rounded-3 overflow-hidden" style="display: none;">
                    <div class="row g-0">
                        <!-- Left Image -->
                        <div class="col-lg-6 d-none d-lg-flex align-items-center p-4 bg-light">
                            <img src="{% static 'assets/images/element/signin.svg' %}" class="img-fluid" alt="OTP Verification illustration">
                        </div>
                        <!-- OTP Form -->
                        <div class="col-lg-6 p-4 p-sm-5">
                            <a href="index.html">
                                <img src="{% static 'assets/images/logo.png' %}" alt="logo" class="h-30px mb-3 mb-md-4">
                            </a>
                            <div class="otp-container">
                                <div class="otp-header">
                                    <p>
                                        An OTP has been sent to <strong><span id="otpEmail"></span></strong>
                                        <button type="button" id="editEmailBtn" class="edit-email-btn">Edit Email</button>
                                    </p>
                                </div>
                                <div class="otp-inputs">
                                    <input type="text" class="otp-input" maxlength="1" data-index="1">
                                    <input type="text" class="otp-input" maxlength="1" data-index="2">
                                    <input type="text" class="otp-input" maxlength="1" data-index="3">
                                    <input type="text" class="otp-input" maxlength="1" data-index="4">
                                    <input type="text" class="otp-input" maxlength="1" data-index="5">
                                    <input type="text" class="otp-input" maxlength="1" data-index="6">
                                </div>
                                <button type="button" id="verifyOtpBtn" class="btn btn-primary w-100">
                                    <span class="spinner-border2" role="status"></span>
                                    <span class="btn-text">Verify OTP & Register</span>
                                </button>
                                <div class="mt-3 text-center">
                                    <button type="button" id="resendOtpBtn" class="btn btn-link" disabled>
                                        Resend OTP (<span id="timer">60</span>s)
                                    </button>
                                </div>
                                <script>
                                    let timerInterval;
                                    let timeLeft = 60;

                                    function startTimer() {
                                        timeLeft = 60;
                                        const timerDisplay = document.getElementById('timer');
                                        const resendBtn = document.getElementById('resendOtpBtn');
                                        resendBtn.disabled = true;

                                        timerInterval = setInterval(() => {
                                            timeLeft--;
                                            timerDisplay.textContent = timeLeft;
                                            
                                            if (timeLeft <= 0) {
                                                clearInterval(timerInterval);
                                                resendBtn.disabled = false;
                                                timerDisplay.textContent = '60';
                                            }
                                        }, 1000);
                                    }

                                    // Start timer when OTP is first sent
                                    startTimer();

                                    // Handle resend OTP click
                                    document.getElementById('resendOtpBtn').addEventListener('click', function() {
                                        $.ajax({
                                            type: 'POST',
                                            url: '{% url "send_otp" %}',
                                            data: {
                                                email: registrationData.email,
                                                csrfmiddlewaretoken: '{{ csrf_token }}'
                                            },
                                            success: function(response) {
                                                if(response.success) {
                                                    startTimer();
                                                }
                                            }
                                        });
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of OTP Verification Container -->
            </div>
        </div>
    </section>
</main>

<!-- intl-tel-input CSS & JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/intlTelInput.min.js"></script>

<script>
    // Initialize intl-tel-input for phone number formatting
    const phoneInput = document.querySelector("#phone");
    const iti = window.intlTelInput(phoneInput, {
        initialCountry: "in",
        separateDialCode: true,
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js"
    });

    // Global object to store registration data
    let registrationData = {};

    $(document).ready(function() {
        const $btn = $('#sendOtpBtn');
        $btn.find('.spinner-border').hide();
        // Handle registration form submission (Send OTP)
        $('#signupForm').submit(function(e) {
            e.preventDefault();

            $btn.prop('disabled', true);
            $btn.find('.spinner-border').show();

            // Collect registration data
            registrationData = {
                first_name: $('#first_name').val(),
                last_name: $('#last_name').val(),
                email: $('#email').val(),
                password: $('#password').val(),
                phone: iti.getNumber(),
                country_code: iti.getSelectedCountryData().iso2
            };

            // Request OTP for the entered email
            $.ajax({
                type: 'POST',
                url: '{% url "send_otp" %}',  // Endpoint to send OTP
                data: {
                    email: registrationData.email,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        // Hide registration form, show OTP container and update OTP message
                        $('#registrationContainer').hide();
                        $('#otpContainer').show();
                        $('#otpEmail').text(registrationData.email);
                        // Clear and focus the first OTP input
                        $('.otp-input').val('').first().focus();
                    } else {
                        $('#error-trigger div').text(response.message);
                        $('#error-trigger').fadeIn().delay(4000).fadeOut();
                    }
                },
                error: function(error) {
                    console.log("Error", error.responseJSON?.message);
                    $('#error-trigger div').text(error.responseJSON?.message);
                    $('#error-trigger').fadeIn().delay(4000).fadeOut();
                },
                complete: function() {
                    // Hide loading spinner and enable button
                    $btn.prop('disabled', false);
                    $btn.find('.spinner-border').hide();
                }
            });
        });

        // Auto-focus next OTP input upon entry and allow backspace navigation
        $('.otp-input').on('input', function() {
            if (this.value.length === this.maxLength) {
                $(this).next('.otp-input').focus();
            }
        }).on('keydown', function(e) {
            if (e.key === "Backspace" && $(this).val() === "") {
                $(this).prev('.otp-input').focus();
            }
        });

        // Handle OTP verification and user creation
        $('#verifyOtpBtn').click(function() {
            // Combine the OTP digits into a string
            let otp = '';
            $('.otp-input').each(function() {
                otp += $(this).val();
            });

            if (otp.length < 6) {
                $('#error-trigger div').text("Please enter a 6-digit OTP.");
                $('#error-trigger').fadeIn().delay(4000).fadeOut();
                return;
            }

            // Verify OTP and create the user
            const $btn2 = $('#verifyOtpBtn');
            $btn2.prop('disabled', true);
            $btn2.find('.spinner-border2').show();
            $.ajax({
                type: 'POST',
                url: '{% url "register" %}',  // Endpoint for OTP verification & account creation
                data: {
                    otp: otp,
                    email: registrationData.email,
                    password: registrationData.password,
                    first_name: registrationData.first_name,
                    last_name: registrationData.last_name,
                    phone: registrationData.phone,
                    country_code: registrationData.country_code,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        // Registration complete – redirect as needed
                        window.location.href = '/';
                    } else {
                        $('#error-trigger div').text(response.message);
                        $('#error-trigger').fadeIn().delay(4000).fadeOut();
                        $btn2.prop('disabled', false);
                        $btn2.find('.spinner-border2').hide();
                    }
                },
                error: function(error) {
                    console.log("Error", error.responseJSON?.message);
                    $('#error-trigger div').text(error.responseJSON?.message);
                    $('#error-trigger').fadeIn().delay(4000).fadeOut();
                },
                complete: function() {
                    // Hide loading spinner and enable button
                    $btn2.prop('disabled', false);
                    $btn2.find('.spinner-border2').hide();
                }
            });
        });

        // Handle "Edit Email" button click – return to registration form
        $('#editEmailBtn').click(function() {
            $('#otpContainer').hide();
            $('#registrationContainer').show();
        });
        
        // Improve mobile experience by ensuring proper keyboard type
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // Set numeric keyboard for OTP inputs on mobile
            $('.otp-input').attr('inputmode', 'numeric');
            // Set email keyboard for email field
            $('#email').attr('inputmode', 'email');
            // Set numeric keyboard for phone
            $('#phone').attr('inputmode', 'tel');
        }
    });
</script>
{% endblock %}
